import React, { useState, useEffect, useId } from 'react';
import { useNavigate } from 'react-router-dom';
import Button from 'react-bootstrap/Button';
import swal from 'sweetalert';
import Input from '../components/Input';

export default function Profile() {
    const [name, setName] = useState('');
    const [password, setPassword] = useState('');
    const [email, setEmail] = useState('');
    const [country, setCountry] = useState('');
    const [editing, setEditing] = useState(false);
    const [orders, setOrders] = useState([]);
    const navigate = useNavigate();

    useEffect(() => {
        const fetchUserData = async () => {
            try {
                const userId = JSON.parse(localStorage.getItem('user-id'));
                const response = await fetch(`http://localhost:8000/api/profile/${userId}`);
                const userData = await response.json();
                setName(userData.user.name);
                setPassword(userData.password);
                setEmail(userData.user.email);
                setCountry(userData.user.country);


                const ordersResponse = await fetch(`http://localhost:8000/api/orders/${userId}`);
                const ordersData = await ordersResponse.json();
                setOrders(ordersData.orders);
                console.log('User orders: ');
                console.log(ordersData);
            } catch (error) {
                console.log(error);
            }
        };

        fetchUserData()
            .then(() => {
                console.log("Profile Name: " + name);

            });
    }, []);




    async function handleSubmit(event) {
        event.preventDefault();
        const baseUrl = 'http://localhost:8000/api/profileEdit';

        try {
            const response = await fetch(baseUrl, {
                method: 'POST',
                body: JSON.stringify({
                    name: name,
                    email: email,
                    password: password,
                    country: country
                }),
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            const jsonData = await response.json();
            if (jsonData.success === true) {
                localStorage.setItem('user-info', JSON.stringify(jsonData.user));
                navigate('/');
            } else {
                swal('error email ya registrado');
            }
        } catch (error) {
            console.log(error);
            swal('correo ya esta en uso');
        }
    }
    function handleCountry(country) {
        console.log(country)
        setCountry(country)
    }
    function handleEditClick() {
        if (editing === true) {
            setEditing(false);
        } else {
            setEditing(true);
        }

    }
    async function handleDeleteAccount() {
        try {
            const userId = JSON.parse(localStorage.getItem('user-id'));
            console.log('Delete id: ')
            console.log(userId)
            const response = await fetch(`http://localhost:8000/api/profile/${userId}`, {
                method: 'DELETE'
            });
            const jsonData = await response.json();
            if (jsonData.success === true) {
                localStorage.removeItem('user-info');
                localStorage.removeItem('user-id');
                navigate('/');
            } else {
                swal('Error al eliminar la cuenta');
            }
        } catch (error) {
            console.log(error);
            swal('Error al eliminar la cuenta');
        }
    }

    return (
        <div className="container rounded bg-white mt-5 mb-5">
            <div>
                <h1>Perfil</h1>
                {editing ? (
                    <form action="/profile" method="post" className="col-sm-6 offset-sm-3">
                        <div>
                            <Input
                                attribute={{
                                    id: 'name',
                                    name: 'name',
                                    placeholder: 'Nombre',
                                    type: 'text',

                                }}
                            //handleChange={handleName} 
                            />
                        </div>
                        <div>
                            <Input
                                attribute={{
                                    id: 'password',
                                    name: 'password',
                                    type: 'password',
                                    placeholder: 'contraseña'

                                }}
                            //handleChange={handlePass} 
                            />
                        </div>
                        <div>
                            <Input
                                attribute={{
                                    id: 'email',
                                    name: 'email',
                                    type: 'email',
                                    placeholder: 'correo'
                                }}
                            //handleChange={handleEmail}
                            />
                        </div>
                        <div>
                            <select id="country" name="country" defaultValue="spain" onChange={(e) => handleCountry(e.target.value)}>

                                <option value="spain" selected>España</option>
                                <option value="uk">Reino Unido</option>
                                <option value="italia">Italia</option>
                                <option value="francia">Francia</option>

                            </select>

                        </div>
                        <div style={{ marginTop: '1rem' }}>
                            <Button onClick={handleSubmit}>Guardar</Button>
                            <Button onClick={handleEditClick}>Cancelar</Button>
                        </div>
                        <div style={{ marginTop: '1rem' }}>
                            <button type="button" className="btn btn-danger">Borrar cuenta</button>
                        </div>
                    </form>

                ) : (
                    <div className="text-center">
                        <div className="d-inline-block text-left">
                            <ul className="list-group">
                                <li className="list-group-item custom-list-item">Nombre: </li>
                                <li className="list-group-item custom-list-item">{name}</li>
                                <li className="list-group-item custom-list-item">Email: </li>
                                <li className="list-group-item custom-list-item">{email}</li>
                                <li className="list-group-item custom-list-item">País: </li>
                                <li className="list-group-item custom-list-item">{country}</li>
                            </ul>
                        </div>
                        <div className="d-inline-block text-left">
                            <ul className="list-group">
                                <li className="list-group-item custom-list-item">Pedidos realizados: </li>
                                {orders.map((order) => (
                                    <li className="list-group-item custom-list-item" key={order.id}>
                                        {order.details}
                                    </li>
                                ))}
                            </ul>
                        </div>
                        <div className="mt-4">
                            <Button onClick={handleEditClick}>Editar Perfil</Button>
                        </div>
                        <div className="mt-4">
                            <button className="btn btn-danger" onClick={handleDeleteAccount}>Borrar cuenta</button>
                        </div>
                    </div>

                )}
            </div>
        </div>



    );
}
